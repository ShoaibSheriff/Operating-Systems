#!/bin/sh
echo "<-- size constraint files - delete if large fails (run after enabling) -->"
echo "<-- Create big files and check if old version can be resored -->"
echo "<-- fails as old version is deleted due to size constraints-->"
# set -x
mkdir -p /test/bkpfs/dummy
mkdir -p /mnt/bkpfs

max_bkps=5
file_name=$(( ( RANDOM % 10000 )  + 1 ))

mount -t bkpfs -o "maxver=$max_bkps,maxsize=1" /test/bkpfs /mnt/bkpfs

# 1000 characters
echo "5mzmtSxAGZsRTIRpRI22TDbrCnUSNVsVVVsBQeSKk0AFMDVbeCYAS8Fi4Nc2S31Wo3DcpRGsE2RUL9YUXcGJu3CBKnAFjw4Or8ONmhkSQeEnbpgSYB2XAlBt0uFxKwmRqHYz051sXGpkznWMCqboiFXmFfdofk2u5vmNRRbA0EbetJvusTycqrUnTnmDkoHNuaOEnDTPVngEHFqGVRchuUFnS09XymzUANeei4zG8lBrOWfxwtB2zjB03ZYNUlr0ynd9bnkfcOPlK0wPftbDoYigiMIFhZ5Z5zN6GqVgGEZg9CM10jMot4osT4CxrjY9RNKVnaAVDA1mttO5S3dcZc4zJlhSuH4jTQQ5bwZBP9cXHfr9mn0ToT8pkg2oVIyQKIeuRcIKqu61Jz156K1RDY9XLYOlUNnNpYk5t8Sox6Qr4KdAp3JlSC3cw7HhDST23x14ttO8qxeKY3sAfKHaCebwr0UZxzMqYsZWDrVcSXC0j3troTKIBK1ojUrIlgyCeWsNpFX2Ei85ye7KiQUgViCCAZsLLUc4ze7VnCPOkTLw8sI9rR3lRVr7CugwzLbeNmTQOO4iyJne7SRPX0fKOyUwRCwNtpx2nvKWtJdZr18ecXzqltBWipMmbkyxFajvKgBcsGl52WM9laWGCcqodFu1aEboXdnHiPWVoCGEDD34yJ3jtjK2K0KypSThwpaksdg3wAKHiCITD2LxuTgNNNu7XRbkMrfbCA4sKYW2llHwxdnRhYiBFmXsoMivpxx4WvivmG6trl9JTAJo0SZepj7X76OY1j2nvwiL3qm3nEmfuDUPgt7i7tLtbxnsjUxzAWM1tRFmONu2cHgRra5p6XQY1iikS8ZLi2zYjAirbca8RQaxsWKJd0MEDdKDCxamTUexZDHvzb2clRL8xB7DLAc2FDj87rCOYoFxi4gZ0fg9rLHnGJvnaPerxQbBNSMOnX1AQ2nhDTmLLBmXaoa5LFSyAbSsbzwL4chFZNuX" > "/mnt/bkpfs/dummy/$file_name.txt"
echo "5mzmtSxAGZsRTIRpRI22TDbrCnUSNVsVVVsBQeSKk0AFMDVbeCYAS8Fi4Nc2S31Wo3DcpRGsE2RUL9YUXcGJu3CBKnAFjw4Or8ONmhkSQeEnbpgSYB2XAlBt0uFxKwmRqHYz051sXGpkznWMCqboiFXmFfdofk2u5vmNRRbA0EbetJvusTycqrUnTnmDkoHNuaOEnDTPVngEHFqGVRchuUFnS09XymzUANeei4zG8lBrOWfxwtB2zjB03ZYNUlr0ynd9bnkfcOPlK0wPftbDoYigiMIFhZ5Z5zN6GqVgGEZg9CM10jMot4osT4CxrjY9RNKVnaAVDA1mttO5S3dcZc4zJlhSuH4jTQQ5bwZBP9cXHfr9mn0ToT8pkg2oVIyQKIeuRcIKqu61Jz156K1RDY9XLYOlUNnNpYk5t8Sox6Qr4KdAp3JlSC3cw7HhDST23x14ttO8qxeKY3sAfKHaCebwr0UZxzMqYsZWDrVcSXC0j3troTKIBK1ojUrIlgyCeWsNpFX2Ei85ye7KiQUgViCCAZsLLUc4ze7VnCPOkTLw8sI9rR3lRVr7CugwzLbeNmTQOO4iyJne7SRPX0fKOyUwRCwNtpx2nvKWtJdZr18ecXzqltBWipMmbkyxFajvKgBcsGl52WM9laWGCcqodFu1aEboXdnHiPWVoCGEDD34yJ3jtjK2K0KypSThwpaksdg3wAKHiCITD2LxuTgNNNu7XRbkMrfbCA4sKYW2llHwxdnRhYiBFmXsoMivpxx4WvivmG6trl9JTAJo0SZepj7X76OY1j2nvwiL3qm3nEmfuDUPgt7i7tLtbxnsjUxzAWM1tRFmONu2cHgRra5p6XQY1iikS8ZLi2zYjAirbca8RQaxsWKJd0MEDdKDCxamTUexZDHvzb2clRL8xB7DLAc2FDj87rCOYoFxi4gZ0fg9rLHnGJvnaPerxQbBNSMOnX1AQ2nhDTmLLBmXaoa5LFSyAbSsbzwL4chFZNuX" > "/mnt/bkpfs/dummy/$file_name.txt"
echo "5mzmtSxAGZsRTIRpRI22TDbrCnUSNVsVVVsBQeSKk0AFMDVbeCYAS8Fi4Nc2S31Wo3DcpRGsE2RUL9YUXcGJu3CBKnAFjw4Or8ONmhkSQeEnbpgSYB2XAlBt0uFxKwmRqHYz051sXGpkznWMCqboiFXmFfdofk2u5vmNRRbA0EbetJvusTycqrUnTnmDkoHNuaOEnDTPVngEHFqGVRchuUFnS09XymzUANeei4zG8lBrOWfxwtB2zjB03ZYNUlr0ynd9bnkfcOPlK0wPftbDoYigiMIFhZ5Z5zN6GqVgGEZg9CM10jMot4osT4CxrjY9RNKVnaAVDA1mttO5S3dcZc4zJlhSuH4jTQQ5bwZBP9cXHfr9mn0ToT8pkg2oVIyQKIeuRcIKqu61Jz156K1RDY9XLYOlUNnNpYk5t8Sox6Qr4KdAp3JlSC3cw7HhDST23x14ttO8qxeKY3sAfKHaCebwr0UZxzMqYsZWDrVcSXC0j3troTKIBK1ojUrIlgyCeWsNpFX2Ei85ye7KiQUgViCCAZsLLUc4ze7VnCPOkTLw8sI9rR3lRVr7CugwzLbeNmTQOO4iyJne7SRPX0fKOyUwRCwNtpx2nvKWtJdZr18ecXzqltBWipMmbkyxFajvKgBcsGl52WM9laWGCcqodFu1aEboXdnHiPWVoCGEDD34yJ3jtjK2K0KypSThwpaksdg3wAKHiCITD2LxuTgNNNu7XRbkMrfbCA4sKYW2llHwxdnRhYiBFmXsoMivpxx4WvivmG6trl9JTAJo0SZepj7X76OY1j2nvwiL3qm3nEmfuDUPgt7i7tLtbxnsjUxzAWM1tRFmONu2cHgRra5p6XQY1iikS8ZLi2zYjAirbca8RQaxsWKJd0MEDdKDCxamTUexZDHvzb2clRL8xB7DLAc2FDj87rCOYoFxi4gZ0fg9rLHnGJvnaPerxQbBNSMOnX1AQ2nhDTmLLBmXaoa5LFSyAbSsbzwL4chFZNuX" > "/mnt/bkpfs/dummy/$file_name.txt"

cd ..
./bkpctl -r "1" "/mnt/bkpfs/dummy/$file_name.txt"

if [ "$?" -eq 0 ]; then
  echo "Succesful"
else
	echo "Failed"
fi

umount /mnt/bkpfs

